# clickhouse笔记

1. ck为什么这么快？

- 列式存储

- 数据压缩：在列级别上应用压缩算法减小磁盘存储和网络传输开销。

- 多级树合并结构：ck引擎采用多级树合并结构，新的结构被插入最底层，然后通过定期的合并操作，数据逐渐被优化和合并到最高层。


1. ck适用的场景和不适用的场景

- 高性能OLAP数据库

- 不适用OLTP事务操作场景

    - 不支持事务

    - 不擅长根据主键按行粒度进行查询，不能作为key-value数据库使用

    - 不擅长按行删除数据

## CK的核心特性包括哪些？

1. 完备的DBMS管理功能

    - DDL

    - DML

    - 权限控制

    - 数据备份和恢复

    - 分布式管理

2. 列式存储和数据压缩

假设表A共计20个字段， select A1, A2, A2 from A。

- 对于行数据库，需要扫描所有的行，所有的字段，然后再从中选择A1, A2, A3.

- 对于列数据库，直接选择A1, A2, A3列，较少扫描

数据压缩：同一个列的数据具有相同的数据类型和语义，重复概率大，压缩率高。

列和列之间使用不同的文件存储

3. 向量化引擎

向量化的存储和执行方式在大规模数据分析时非常高效：

- SIMD指令： ClickHouse使用SIMD指令集来对列进行向量化操作。这意味着可以一次性对列中的多个元素执行相同的操作，而不是逐个元素进行操作，从而充分利用现代CPU的并行计算能力。

4. 关系模型和SQL查询

5. 多样化的引擎

## 分区

1. 什么是分区？

数据分区是逻辑上的划分，它并不是将数据物理上分散在不同的位置，而是通过一些规则将表中的数据按照某种逻辑划分成多个部分

2. 如何分区？

数据分区通常基于表中的一个或多个列，这些列被称为分区键。根据分区键的值，表中的数据被划分到不同的分区中。分区键的选择取决于数据的特性和查询的需求。

3. 分区的类型？

ClickHouse 支持多种分区类型，包括范围分区、列表分区、哈希分区等。不同类型的分区适用于不同的场景和数据分布情况。

4. 分区的优势？

 数据分区可以显著提高查询性能。当查询的条件与分区键相关时，ClickHouse 可以只扫描符合条件的分区，而不是整个表，从而减少了查询的数据量，提高了查询效率。

## MergeTree

### mergeTree的结构

数据会按照分区目录的形式保存到磁盘中，存储结构如下：

- table_name（目录）

    - partition_1（目录）

        - 各种文件

    - partiton_2（目录）

        - 各种文件


## 集群、副本、分片

ck的N个节点组成一个集群，在N个节点上都有一张结构相同的数据表Y。如果N1上Y和N2上的Y数据不相同，则N1和N2互为分片；如果相同的会为副本。

- 分片：实现数据的水平切分

- 副本：实现数据的冗余

## distributed原理解析

- 本地表：一张本地表对应一个数据分片

- 分布式表：分布式表只能使用分布式表引擎，和本地表形成一对多的关系


 
